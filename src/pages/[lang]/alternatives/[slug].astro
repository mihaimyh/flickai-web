---
import { getCollection } from 'astro:content';
import BlogLayout from '../../../layouts/BlogLayout.astro';
import { getTranslations, getLangPrefix, getLocaleFromParams } from '../../../utils/i18n';
import { isValidAlternativeSlug } from '../../../utils/alternatives';

export async function getStaticPaths() {
  const alternatives = await getCollection('alternatives');
  
  return alternatives.map((alternative) => {
    // Astro creates slugs like "expensify-alternatives-es" from "expensify-alternatives.es.md"
    // For English files (expensify-alternatives.md), slug is "expensify-alternatives"
    // Remove the language suffix (e.g., "-es", "-de") to get the base slug
    const cleanSlug = alternative.slug.replace(/-(ar|de|es|fr|hi|id|it|ro|zh)$/, '');
    
    return {
      params: { 
        lang: alternative.data.lang,
        slug: cleanSlug
      },
      props: { alternative },
    };
  });
}

const { alternative } = Astro.props;
const { lang, slug } = Astro.params;

// Validate slug is a valid alternative slug
if (!slug || !isValidAlternativeSlug(slug)) {
  return Astro.redirect('/404');
}

const locale = getLocaleFromParams({ lang: alternative.data.lang });
const translations = getTranslations(locale);
const alternatives = translations.alternatives || {};
const langPrefix = getLangPrefix(locale);
const { Content } = await alternative.render();
---

<BlogLayout 
  title={alternative.data.title}
  description={alternative.data.description}
  keywords={alternative.data.keywords}
  lang={alternative.data.lang}
  publishDate={alternative.data.publishDate}
>
  <Content />
  
  <div class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
    <p class="text-center">
      <a href={`${langPrefix}/alternatives/`} class="text-primary hover:text-primary-dark font-semibold">
        ‚Üê {alternatives.backToHub || 'Back to Alternatives'}
      </a>
    </p>
  </div>
</BlogLayout>
